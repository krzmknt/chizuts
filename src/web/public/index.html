<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>graphts - Dependency Graph Visualizer</title>
    <script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>
    <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
    <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: #1a1a2e;
        color: #eee;
        overflow: hidden;
      }

      #header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 50px;
        background: #16213e;
        display: flex;
        align-items: center;
        padding: 0 20px;
        gap: 20px;
        z-index: 100;
        border-bottom: 1px solid #0f3460;
      }

      #header h1 {
        font-size: 18px;
        font-weight: 600;
        color: #e94560;
      }

      #stats {
        font-size: 14px;
        color: #888;
      }

      #controls {
        display: flex;
        gap: 10px;
        margin-left: auto;
      }

      button {
        background: #0f3460;
        color: #eee;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        transition: background 0.2s;
      }

      button:hover {
        background: #e94560;
      }

      select {
        background: #0f3460;
        color: #eee;
        border: none;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 13px;
      }

      #left-sidebar {
        position: fixed;
        top: 50px;
        left: 0;
        width: 280px;
        bottom: 0;
        background: #16213e;
        border-right: 1px solid #0f3460;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      #search-container {
        padding: 15px;
        border-bottom: 1px solid #0f3460;
      }

      #search-input {
        width: 100%;
        background: #0f3460;
        color: #eee;
        border: 1px solid #1a1a2e;
        padding: 10px 12px;
        border-radius: 4px;
        font-size: 13px;
        outline: none;
        transition: border-color 0.2s;
      }

      #search-input:focus {
        border-color: #e94560;
      }

      #search-input::placeholder {
        color: #666;
      }

      #search-results {
        font-size: 12px;
        color: #888;
        margin-top: 8px;
      }

      #file-tree-container {
        flex: 1;
        overflow-y: auto;
        padding: 10px 0;
      }

      .tree-item {
        padding: 6px 15px 6px 15px;
        font-size: 13px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: background 0.15s;
      }

      .tree-item:hover {
        background: #0f3460;
      }

      .tree-item.selected {
        background: #e94560;
      }

      .tree-item.match {
        background: rgba(233, 69, 96, 0.3);
      }

      .tree-folder {
        color: #888;
        font-weight: 500;
      }

      .tree-folder::before {
        content: 'üìÅ';
        font-size: 12px;
      }

      .tree-folder.open::before {
        content: 'üìÇ';
      }

      .tree-file::before {
        content: 'üìÑ';
        font-size: 12px;
      }

      .tree-symbol {
        color: #ccc;
      }

      .symbol-icon {
        display: inline-block;
        width: 16px;
        height: 16px;
        line-height: 16px;
        text-align: center;
        border-radius: 3px;
        font-size: 10px;
        font-weight: bold;
        margin-right: 4px;
      }

      .tree-symbol-function .symbol-icon {
        background: #2ecc71;
        color: #fff;
      }

      .tree-symbol-class .symbol-icon {
        background: #9b59b6;
        color: #fff;
      }

      .tree-symbol-variable .symbol-icon {
        background: #f39c12;
        color: #fff;
      }

      .tree-symbol-component .symbol-icon {
        background: #e74c3c;
        color: #fff;
      }

      .tree-symbol-interface .symbol-icon {
        background: #1abc9c;
        color: #fff;
      }

      .tree-symbol-type .symbol-icon {
        background: #e67e22;
        color: #fff;
      }

      .tree-children {
        display: none;
      }

      .tree-children.open {
        display: block;
      }

      /* Dynamic indentation - base padding + depth * 15px */

      #cy {
        position: fixed;
        top: 50px;
        left: 280px;
        right: 300px;
        bottom: 0;
      }

      #sidebar {
        position: fixed;
        top: 50px;
        right: 0;
        width: 300px;
        bottom: 0;
        background: #16213e;
        border-left: 1px solid #0f3460;
        padding: 20px;
        overflow-y: auto;
      }

      #sidebar h2 {
        font-size: 14px;
        color: #888;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      #node-info {
        font-size: 13px;
        line-height: 1.6;
      }

      #node-info .label {
        color: #e94560;
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 10px;
      }

      #node-info .type {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 3px;
        font-size: 11px;
        text-transform: uppercase;
        margin-bottom: 15px;
      }

      #node-info .type.module {
        background: #3498db;
      }
      #node-info .type.function {
        background: #2ecc71;
      }
      #node-info .type.class {
        background: #9b59b6;
      }
      #node-info .type.variable {
        background: #f39c12;
      }
      #node-info .type.component {
        background: #e74c3c;
      }
      #node-info .type.interface {
        background: #1abc9c;
      }
      #node-info .type.type {
        background: #e67e22;
      }

      #node-info .path {
        color: #888;
        font-family: monospace;
        font-size: 12px;
        word-break: break-all;
      }

      #node-info .location {
        color: #666;
        font-size: 12px;
        margin-top: 5px;
      }

      #filter-section {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #0f3460;
      }

      #filter-section label {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 8px 0;
        cursor: pointer;
        font-size: 13px;
      }

      #filter-section input[type='checkbox'] {
        width: 16px;
        height: 16px;
      }

      #legend {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #0f3460;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 6px 0;
        font-size: 12px;
      }

      .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 2px;
      }

      .legend-line {
        width: 20px;
        height: 3px;
        border-radius: 1px;
      }

      #edge-legend {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #0f3460;
      }

      #loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 18px;
        color: #888;
      }
    </style>
  </head>
  <body>
    <div id="header">
      <h1>graphts</h1>
      <span id="stats">Loading...</span>
      <div id="controls">
        <select id="layout">
          <option value="dagre">Hierarchical (dagre)</option>
          <option value="cose">Force-directed (cose)</option>
          <option value="breadthfirst">Breadthfirst</option>
          <option value="circle">Circle</option>
          <option value="grid">Grid</option>
        </select>
        <button id="fit-btn">Fit to Screen</button>
        <button id="export-btn">Export PNG</button>
      </div>
    </div>

    <div id="left-sidebar">
      <div id="search-container">
        <input
          type="text"
          id="search-input"
          placeholder="Search files..."
          autocomplete="off"
        />
        <div id="search-results"></div>
      </div>
      <div id="file-tree-container">
        <div id="file-tree"></div>
      </div>
    </div>

    <div id="cy"></div>

    <div id="sidebar">
      <h2>Node Details</h2>
      <div id="node-info">
        <p style="color: #666">Click a node to see details</p>
      </div>

      <div id="filter-section">
        <h2>Filter by Type</h2>
        <label
          ><input type="checkbox" data-type="module" checked /> Modules</label
        >
        <label
          ><input type="checkbox" data-type="function" checked />
          Functions</label
        >
        <label
          ><input type="checkbox" data-type="class" checked /> Classes</label
        >
        <label
          ><input type="checkbox" data-type="variable" checked />
          Variables</label
        >
        <label
          ><input type="checkbox" data-type="component" checked />
          Components</label
        >
        <label
          ><input type="checkbox" data-type="interface" checked />
          Interfaces</label
        >
        <label><input type="checkbox" data-type="type" checked /> Types</label>
      </div>

      <div id="legend">
        <h2>Nodes</h2>
        <div class="legend-item">
          <div class="legend-color" style="background: #3498db"></div>
          Module
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #2ecc71"></div>
          Function
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #9b59b6"></div>
          Class
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #f39c12"></div>
          Variable
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #e74c3c"></div>
          Component
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #1abc9c"></div>
          Interface
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #e67e22"></div>
          Type
        </div>
      </div>

      <div id="edge-legend">
        <h2>Edges</h2>
        <div class="legend-item">
          <div class="legend-line" style="background: #3498db"></div>
          import
        </div>
        <div class="legend-item">
          <div class="legend-line" style="background: #2ecc71"></div>
          export
        </div>
        <div class="legend-item">
          <div class="legend-line" style="background: #e74c3c"></div>
          call
        </div>
        <div class="legend-item">
          <div class="legend-line" style="background: #f39c12"></div>
          reference
        </div>
        <div class="legend-item">
          <div class="legend-line" style="background: #9b59b6"></div>
          extends
        </div>
        <div class="legend-item">
          <div class="legend-line" style="background: #1abc9c"></div>
          implements
        </div>
      </div>
    </div>

    <div id="loading">Loading graph...</div>

    <script>
      const NODE_COLORS = {
        module: '#3498db',
        function: '#2ecc71',
        class: '#9b59b6',
        variable: '#f39c12',
        component: '#e74c3c',
        interface: '#1abc9c',
        type: '#e67e22',
      };

      const EDGE_COLORS = {
        import: '#3498db',
        export: '#2ecc71',
        call: '#e74c3c',
        reference: '#f39c12',
        extends: '#9b59b6',
        implements: '#1abc9c',
      };

      let cy;
      let graphNodes = [];

      // Build directory tree from relative file paths with child symbols
      function buildFileTree(nodes) {
        const tree = {};

        // Get modules and their children
        const modules = nodes.filter((n) => n.type === 'module');
        const symbols = nodes.filter((n) => n.type !== 'module');

        // Build module tree
        for (const node of modules) {
          const parts = node.label.split('/').filter(Boolean);
          let current = tree;

          for (let i = 0; i < parts.length; i++) {
            const part = parts[i];
            const isFile = i === parts.length - 1;

            if (!current[part]) {
              current[part] = isFile
                ? {
                    __isFile: true,
                    __nodeId: node.id,
                    __label: node.label,
                    __children: [],
                  }
                : {};
            }
            current = current[part];
          }
        }

        // Add symbols to their parent modules
        for (const symbol of symbols) {
          // Find parent module by matching file path
          const parentModule = modules.find((m) =>
            symbol.id.startsWith(m.id + '#')
          );
          if (parentModule) {
            const parts = parentModule.label.split('/').filter(Boolean);
            let current = tree;

            for (const part of parts) {
              if (current[part]) {
                current = current[part];
              }
            }

            if (current.__children) {
              current.__children.push({
                id: symbol.id,
                label: symbol.label,
                type: symbol.type,
              });
            }
          }
        }

        return tree;
      }

      // Symbol type icons
      const SYMBOL_ICONS = {
        function: '∆í',
        class: 'C',
        variable: 'V',
        component: '‚öõ',
        interface: 'I',
        type: 'T',
      };

      // Render the file tree
      function renderFileTree(tree, container, depth = 0) {
        const entries = Object.entries(tree).sort(([a, aVal], [b, bVal]) => {
          // Folders first, then files
          const aIsFile = aVal.__isFile;
          const bIsFile = bVal.__isFile;
          if (aIsFile !== bIsFile) return aIsFile ? 1 : -1;
          return a.localeCompare(b);
        });

        for (const [name, value] of entries) {
          if (name.startsWith('__')) continue;

          const isFile = value.__isFile;
          const indentPadding = 15 + depth * 15; // Base 15px + 15px per depth level

          if (isFile) {
            const fileItem = document.createElement('div');
            fileItem.className = 'tree-item tree-file';
            fileItem.style.paddingLeft = `${indentPadding}px`;
            fileItem.textContent = name;
            fileItem.dataset.nodeId = value.__nodeId;

            const fileChildren = document.createElement('div');
            fileChildren.className = 'tree-children';

            // Render symbol children
            if (value.__children && value.__children.length > 0) {
              const sortedSymbols = value.__children.sort((a, b) =>
                a.label.localeCompare(b.label)
              );

              for (const symbol of sortedSymbols) {
                const symbolItem = document.createElement('div');
                symbolItem.className = `tree-item tree-symbol tree-symbol-${symbol.type}`;
                symbolItem.style.paddingLeft = `${indentPadding + 15}px`;
                symbolItem.dataset.nodeId = symbol.id;
                symbolItem.innerHTML = `<span class="symbol-icon">${SYMBOL_ICONS[symbol.type] || '‚Ä¢'}</span> ${symbol.label}`;
                symbolItem.addEventListener('click', (e) => {
                  e.stopPropagation();
                  focusNode(symbol.id);
                });
                fileChildren.appendChild(symbolItem);
              }
            }

            fileItem.addEventListener('click', () => {
              fileItem.classList.toggle('open');
              fileChildren.classList.toggle('open');
              focusNode(value.__nodeId);
            });

            container.appendChild(fileItem);
            if (value.__children && value.__children.length > 0) {
              container.appendChild(fileChildren);
            }
          } else {
            const folder = document.createElement('div');
            folder.className = 'tree-item tree-folder';
            folder.style.paddingLeft = `${indentPadding}px`;
            folder.textContent = name;

            const children = document.createElement('div');
            children.className = 'tree-children';

            folder.addEventListener('click', () => {
              folder.classList.toggle('open');
              children.classList.toggle('open');
            });

            container.appendChild(folder);
            container.appendChild(children);

            renderFileTree(value, children, depth + 1);
          }
        }
      }

      // Focus on a node in the graph
      function focusNode(nodeId) {
        const node = cy.getElementById(nodeId);
        if (node.length > 0) {
          // Clear previous selection
          cy.elements().unselect();
          document.querySelectorAll('.tree-item.selected').forEach((el) => {
            el.classList.remove('selected');
          });

          // Select and focus
          node.select();
          cy.animate({
            center: { eles: node },
            zoom: 1.5,
            duration: 300,
          });

          // Highlight in tree
          const treeItem = document.querySelector(`[data-node-id="${nodeId}"]`);
          if (treeItem) {
            treeItem.classList.add('selected');
          }

          // Show node info
          showNodeInfo(node.data());
        }
      }

      // Search functionality
      function setupSearch() {
        const searchInput = document.getElementById('search-input');
        const searchResults = document.getElementById('search-results');

        searchInput.addEventListener('input', (e) => {
          const query = e.target.value.toLowerCase().trim();

          // Clear previous highlights
          document.querySelectorAll('.tree-item.match').forEach((el) => {
            el.classList.remove('match');
          });
          cy.nodes().removeClass('highlighted');

          if (!query) {
            searchResults.textContent = '';
            return;
          }

          // Find matching nodes
          const matches = graphNodes.filter(
            (n) =>
              n.label.toLowerCase().includes(query) ||
              n.filePath.toLowerCase().includes(query)
          );

          searchResults.textContent = `${matches.length} result${matches.length !== 1 ? 's' : ''}`;

          // Highlight in tree
          for (const match of matches) {
            const treeItem = document.querySelector(
              `[data-node-id="${match.id}"]`
            );
            if (treeItem) {
              treeItem.classList.add('match');
              // Expand parent folders and files
              let parent = treeItem.parentElement;
              while (parent) {
                if (parent.classList.contains('tree-children')) {
                  parent.classList.add('open');
                  const prevSibling = parent.previousElementSibling;
                  if (prevSibling) {
                    prevSibling.classList.add('open');
                  }
                }
                parent = parent.parentElement;
              }
            }

            // Highlight in graph
            const node = cy.getElementById(match.id);
            if (node.length > 0) {
              node.addClass('highlighted');
            }
          }

          // Focus on first match if Enter is pressed
          if (matches.length > 0) {
            searchInput.onkeydown = (evt) => {
              if (evt.key === 'Enter') {
                focusNode(matches[0].id);
              } else if (evt.key === 'Escape') {
                searchInput.value = '';
                searchInput.dispatchEvent(new Event('input'));
              }
            };
          }
        });
      }

      async function init() {
        // Fetch graph data
        const response = await fetch('/api/graph');
        const graph = await response.json();

        // Store for search
        graphNodes = graph.nodes;

        document.getElementById('loading').style.display = 'none';
        document.getElementById('stats').textContent =
          `${graph.nodes.length} nodes, ${graph.edges.length} edges, ${graph.metadata.fileCount} files`;

        // Build and render file tree
        const tree = buildFileTree(graph.nodes);
        const treeContainer = document.getElementById('file-tree');
        renderFileTree(tree, treeContainer);

        // Convert to Cytoscape format
        const elements = [];

        // Add nodes
        for (const node of graph.nodes) {
          elements.push({
            data: {
              id: node.id,
              label: node.label,
              type: node.type,
              filePath: node.filePath,
              line: node.line,
              column: node.column,
              metadata: node.metadata,
            },
          });
        }

        // Add edges
        for (const edge of graph.edges) {
          // Only add edge if both source and target exist
          const sourceExists = graph.nodes.some((n) => n.id === edge.source);
          const targetExists = graph.nodes.some((n) => n.id === edge.target);

          if (sourceExists && targetExists) {
            elements.push({
              data: {
                id: `${edge.source}->${edge.target}`,
                source: edge.source,
                target: edge.target,
                type: edge.type,
              },
            });
          }
        }

        // Initialize Cytoscape
        cy = cytoscape({
          container: document.getElementById('cy'),
          elements,
          style: [
            {
              selector: 'node',
              style: {
                label: 'data(label)',
                'background-color': (ele) =>
                  NODE_COLORS[ele.data('type')] || '#888',
                color: '#fff',
                'text-valign': 'bottom',
                'text-margin-y': 5,
                'font-size': 10,
                width: (ele) => (ele.data('type') === 'module' ? 30 : 20),
                height: (ele) => (ele.data('type') === 'module' ? 30 : 20),
                'border-width': 2,
                'border-color': '#1a1a2e',
              },
            },
            {
              selector: 'node:selected',
              style: {
                'border-width': 3,
                'border-color': '#e94560',
              },
            },
            {
              selector: 'edge',
              style: {
                width: 1,
                'line-color': (ele) => EDGE_COLORS[ele.data('type')] || '#666',
                'target-arrow-color': (ele) =>
                  EDGE_COLORS[ele.data('type')] || '#666',
                'target-arrow-shape': 'triangle',
                'curve-style': 'bezier',
                opacity: 0.6,
              },
            },
            {
              selector: 'edge:selected',
              style: {
                width: 2,
                opacity: 1,
              },
            },
            {
              selector: '.hidden',
              style: {
                display: 'none',
              },
            },
            {
              selector: '.highlighted',
              style: {
                'border-width': 4,
                'border-color': '#e94560',
                'border-style': 'double',
              },
            },
          ],
          layout: {
            name: 'dagre',
            rankDir: 'TB',
            nodeSep: 50,
            rankSep: 80,
            animate: false,
          },
          wheelSensitivity: 0.3,
        });

        // Node click handler
        cy.on('tap', 'node', (evt) => {
          const node = evt.target;
          showNodeInfo(node.data());
        });

        // Setup controls and search
        setupControls();
        setupSearch();
      }

      function showNodeInfo(data) {
        const info = document.getElementById('node-info');
        info.innerHTML = `
        <div class="label">${data.label}</div>
        <div class="type ${data.type}">${data.type}</div>
        <div class="path">${data.filePath}</div>
        <div class="location">Line ${data.line}, Column ${data.column}</div>
        ${data.metadata ? `<pre style="margin-top: 10px; font-size: 11px; color: #888;">${JSON.stringify(data.metadata, null, 2)}</pre>` : ''}
      `;
      }

      function setupControls() {
        // Layout selector
        document.getElementById('layout').addEventListener('change', (e) => {
          const layoutName = e.target.value;
          const layoutOptions = {
            name: layoutName,
            animate: true,
            animationDuration: 500,
          };

          if (layoutName === 'dagre') {
            layoutOptions.rankDir = 'TB';
            layoutOptions.nodeSep = 50;
            layoutOptions.rankSep = 80;
          }

          cy.layout(layoutOptions).run();
        });

        // Fit button
        document.getElementById('fit-btn').addEventListener('click', () => {
          cy.fit();
        });

        // Export button
        document.getElementById('export-btn').addEventListener('click', () => {
          const png = cy.png({ full: true, scale: 2 });
          const link = document.createElement('a');
          link.download = 'dependency-graph.png';
          link.href = png;
          link.click();
        });

        // Type filters
        document
          .querySelectorAll('#filter-section input[type="checkbox"]')
          .forEach((checkbox) => {
            checkbox.addEventListener('change', () => {
              const type = checkbox.dataset.type;
              const visible = checkbox.checked;

              cy.nodes().forEach((node) => {
                if (node.data('type') === type) {
                  if (visible) {
                    node.removeClass('hidden');
                  } else {
                    node.addClass('hidden');
                  }
                }
              });
            });
          });
      }

      // Connect to SSE for watch mode updates
      function setupWatchMode() {
        const eventSource = new EventSource('/api/events');

        eventSource.addEventListener('connected', () => {
          console.log('Watch mode connected');
        });

        eventSource.addEventListener('update', () => {
          console.log('Graph updated, reloading...');
          // Re-fetch and update the graph
          fetch('/api/graph')
            .then((res) => res.json())
            .then((graph) => {
              // Update stats
              document.getElementById('stats').textContent =
                `${graph.nodes.length} nodes, ${graph.edges.length} edges, ${graph.metadata.fileCount} files`;

              // Rebuild elements
              const elements = [];

              for (const node of graph.nodes) {
                elements.push({
                  data: {
                    id: node.id,
                    label: node.label,
                    type: node.type,
                    filePath: node.filePath,
                    line: node.line,
                    column: node.column,
                    metadata: node.metadata,
                  },
                });
              }

              for (const edge of graph.edges) {
                const sourceExists = graph.nodes.some(
                  (n) => n.id === edge.source
                );
                const targetExists = graph.nodes.some(
                  (n) => n.id === edge.target
                );

                if (sourceExists && targetExists) {
                  elements.push({
                    data: {
                      id: `${edge.source}->${edge.target}`,
                      source: edge.source,
                      target: edge.target,
                      type: edge.type,
                    },
                  });
                }
              }

              // Update cytoscape
              cy.elements().remove();
              cy.add(elements);
              cy.layout({
                name: document.getElementById('layout').value,
                animate: false,
              }).run();
            })
            .catch(console.error);
        });

        eventSource.onerror = () => {
          console.log('Watch mode disconnected, will retry...');
        };
      }

      init()
        .then(() => {
          // Try to connect to watch mode (will fail gracefully if not enabled)
          setupWatchMode();
        })
        .catch(console.error);
    </script>
  </body>
</html>
